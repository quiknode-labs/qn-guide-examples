<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>x402 Payment Test</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    .container {
      background: white;
      border-radius: 1rem;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      max-width: 600px;
      width: 100%;
      padding: 2rem;
    }
    h1 {
      color: #333;
      margin-bottom: 0.5rem;
      font-size: 1.75rem;
    }
    .subtitle {
      color: #666;
      margin-bottom: 2rem;
      font-size: 0.9rem;
    }
    .wallet-status {
      background: #f7f7f7;
      padding: 1rem;
      border-radius: 0.5rem;
      margin-bottom: 1.5rem;
      font-size: 0.9rem;
    }
    .wallet-status.connected {
      background: #e8f5e9;
      border: 1px solid #4caf50;
    }
    .endpoints {
      margin-bottom: 2rem;
    }
    .endpoint-card {
      border: 1px solid #e0e0e0;
      border-radius: 0.5rem;
      padding: 1rem;
      margin-bottom: 1rem;
    }
    .endpoint-card h3 {
      color: #667eea;
      font-size: 1rem;
      margin-bottom: 0.5rem;
    }
    .endpoint-card .price {
      font-weight: bold;
      color: #764ba2;
      margin-bottom: 0.5rem;
    }
    .endpoint-card .description {
      color: #666;
      font-size: 0.85rem;
      margin-bottom: 1rem;
    }
    button {
      background: #667eea;
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 0.5rem;
      font-size: 1rem;
      cursor: pointer;
      width: 100%;
      font-weight: 600;
      transition: background 0.2s;
    }
    button:hover:not(:disabled) {
      background: #5568d3;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    button.secondary {
      background: #764ba2;
      margin-top: 0.5rem;
    }
    button.secondary:hover:not(:disabled) {
      background: #5d3a7f;
    }
    .result {
      margin-top: 1rem;
      padding: 1rem;
      border-radius: 0.5rem;
      font-size: 0.85rem;
      font-family: monospace;
      white-space: pre-wrap;
      word-break: break-all;
      max-height: 300px;
      overflow-y: auto;
    }
    .result.success {
      background: #e8f5e9;
      border: 1px solid #4caf50;
      color: #2e7d32;
    }
    .result.error {
      background: #ffebee;
      border: 1px solid #f44336;
      color: #c62828;
    }
    .result.info {
      background: #e3f2fd;
      border: 1px solid #2196f3;
      color: #1565c0;
    }
    .install-instructions {
      background: #fff3cd;
      border: 1px solid #ffc107;
      padding: 1rem;
      border-radius: 0.5rem;
      margin-top: 1rem;
    }
    .install-instructions h4 {
      color: #856404;
      margin-bottom: 0.5rem;
    }
    .install-instructions p {
      color: #856404;
      font-size: 0.85rem;
      margin-bottom: 0.5rem;
    }
    .install-instructions code {
      background: #fff;
      padding: 0.25rem 0.5rem;
      border-radius: 0.25rem;
      font-size: 0.8rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üí≥ x402 Payment Test</h1>
    <p class="subtitle">Test x402 payments with your browser wallet</p>

    <div id="walletStatus" class="wallet-status">
      <strong>Wallet:</strong> Not connected
    </div>

    <button id="connectBtn" onclick="connectWallet()">Connect Wallet</button>

    <div class="endpoints" style="margin-top: 2rem;">
      <h2 style="font-size: 1.25rem; color: #333; margin-bottom: 1rem;">Available Endpoints</h2>

      <div class="endpoint-card">
        <h3>GET /api/weather/current</h3>
        <div class="price">$0.001 USDC</div>
        <div class="description">Current weather data</div>
        <button onclick="makePayment('/api/weather/current', 0.001)" disabled id="btn-weather-current">
          Test Endpoint
        </button>
        <div id="result-weather-current"></div>
      </div>

      <div class="endpoint-card">
        <h3>GET /api/weather/forecast</h3>
        <div class="price">$0.01 USDC</div>
        <div class="description">7-day weather forecast</div>
        <button onclick="makePayment('/api/weather/forecast', 0.01)" disabled id="btn-weather-forecast">
          Test Endpoint
        </button>
        <div id="result-weather-forecast"></div>
      </div>

      <div class="endpoint-card">
        <h3>GET /api/premium</h3>
        <div class="price">$0.005 USDC</div>
        <div class="description">Premium content list</div>
        <button onclick="makePayment('/api/premium', 0.005)" disabled id="btn-premium">
          Test Endpoint
        </button>
        <div id="result-premium"></div>
      </div>
    </div>

    <div class="install-instructions">
      <h4>‚ÑπÔ∏è Demo Info</h4>
      <p>This page demonstrates the complete x402 payment flow:</p>
      <p>1. Fetches payment requirements (402 response)<br>
         2. Signs EIP-712 authorization with your wallet<br>
         3. Submits payment and displays protected content</p>
      <p><strong>Note:</strong> Requires test USDC on Base Sepolia testnet.</p>
    </div>
  </div>

  <script>
    let account = null;

    async function connectWallet() {
      const btn = document.getElementById('connectBtn');
      const status = document.getElementById('walletStatus');

      try {
        btn.disabled = true;
        btn.textContent = 'Connecting...';

        if (!window.ethereum) {
          throw new Error('No wallet detected. Please install MetaMask or Coinbase Wallet.');
        }

        // Request account access
        const accounts = await window.ethereum.request({
          method: 'eth_requestAccounts'
        });

        account = accounts[0];

        status.className = 'wallet-status connected';
        status.innerHTML = `<strong>Wallet:</strong> Connected as ${account.slice(0, 6)}...${account.slice(-4)}`;

        btn.textContent = 'Wallet Connected ‚úì';
        btn.style.background = '#4caf50';

        // Enable all payment buttons
        document.querySelectorAll('button[id^="btn-"]').forEach(btn => {
          btn.disabled = false;
        });

      } catch (error) {
        console.error('Wallet connection error:', error);
        status.innerHTML = `<strong>Error:</strong> ${error.message}`;
        btn.disabled = false;
        btn.textContent = 'Connect Wallet';
      }
    }

    async function makePayment(endpoint, price) {
      // Remove /api prefix and convert to ID format
      const idPart = endpoint.replace(/^\/api\//, '').replace(/\//g, '-');
      const resultId = `result-${idPart}`;
      const resultDiv = document.getElementById(resultId);
      const btnId = `btn-${idPart}`;
      const btn = document.getElementById(btnId);

      if (!account) {
        resultDiv.className = 'result error';
        resultDiv.textContent = 'Please connect your wallet first';
        return;
      }

      try {
        btn.disabled = true;
        btn.textContent = 'Processing...';
        resultDiv.className = 'result info';
        resultDiv.textContent = 'Fetching payment requirements...';

        const url = `http://localhost:3001${endpoint}`;

        // First request to get payment requirements
        const initialResponse = await fetch(url, {
          headers: {
            'Accept': 'application/json'
          }
        });

        if (initialResponse.status !== 402) {
          // Not a paywall, just return the response
          const data = await initialResponse.json();
          resultDiv.className = 'result success';
          resultDiv.textContent = `Response:\n${JSON.stringify(data, null, 2)}`;
          return;
        }

        const paymentRequired = await initialResponse.json();
        const requirement = paymentRequired.accepts[0];

        resultDiv.textContent = 'Signing EIP-712 authorization...';

        // Generate nonce (random bytes32)
        const nonce = '0x' + Array.from(crypto.getRandomValues(new Uint8Array(32)))
          .map(b => b.toString(16).padStart(2, '0')).join('');

        // Current time and validity window
        const validAfter = 0;
        const validBefore = Math.floor(Date.now() / 1000) + 600; // 10 minutes from now

        // EIP-712 typed data for EIP-3009 TransferWithAuthorization
        const typedData = {
          types: {
            EIP712Domain: [
              { name: 'name', type: 'string' },
              { name: 'version', type: 'string' },
              { name: 'chainId', type: 'uint256' },
              { name: 'verifyingContract', type: 'address' }
            ],
            TransferWithAuthorization: [
              { name: 'from', type: 'address' },
              { name: 'to', type: 'address' },
              { name: 'value', type: 'uint256' },
              { name: 'validAfter', type: 'uint256' },
              { name: 'validBefore', type: 'uint256' },
              { name: 'nonce', type: 'bytes32' }
            ]
          },
          primaryType: 'TransferWithAuthorization',
          domain: {
            name: 'USD Coin',
            version: '2',
            chainId: 84532, // base-sepolia
            verifyingContract: requirement.asset
          },
          message: {
            from: account,
            to: requirement.payTo,
            value: requirement.maxAmountRequired,
            validAfter: validAfter.toString(),
            validBefore: validBefore.toString(),
            nonce: nonce
          }
        };

        // Request signature from wallet
        const signature = await window.ethereum.request({
          method: 'eth_signTypedData_v4',
          params: [account, JSON.stringify(typedData)]
        });

        resultDiv.textContent = 'Signature received! Sending payment...';

        // Construct payment payload
        const paymentPayload = {
          x402Version: 1,
          scheme: 'exact',
          network: requirement.network,
          payload: {
            authorization: {
              from: account,
              to: requirement.payTo,
              value: requirement.maxAmountRequired,
              validAfter: validAfter.toString(),
              validBefore: validBefore.toString(),
              nonce: nonce
            },
            signature: signature
          }
        };

        // Base64 encode the payment payload
        const paymentHeader = btoa(JSON.stringify(paymentPayload));

        // Retry request with payment
        const paidResponse = await fetch(url, {
          headers: {
            'Accept': 'application/json',
            'X-Payment': paymentHeader
          }
        });

        const data = await paidResponse.json();

        if (paidResponse.ok) {
          resultDiv.className = 'result success';
          resultDiv.textContent = `‚úì Payment successful! (${price} USDC)\n\nResponse:\n${JSON.stringify(data, null, 2)}`;
        } else {
          resultDiv.className = 'result error';
          resultDiv.textContent = `‚úó Payment failed (${paidResponse.status})\n\n${JSON.stringify(data, null, 2)}`;
        }

      } catch (error) {
        console.error('Payment error:', error);
        resultDiv.className = 'result error';
        resultDiv.textContent = `‚úó Error: ${error.message}`;
      } finally {
        btn.disabled = false;
        btn.textContent = 'Test Endpoint';
      }
    }
  </script>
</body>
</html>
